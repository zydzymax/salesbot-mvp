{% extends "base.html" %}

{% block title %}Dashboard - –ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–¥–∞–∂{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h1>üìä –î–∞—à–±–æ—Ä–¥ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ú–µ–Ω–µ–¥–∂–µ—Ä–æ–≤</h1>
            <a href="/admin/deals" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 500; transition: opacity 0.3s;">
                üìã –í—Å–µ —Å–¥–µ–ª–∫–∏
            </a>
        </div>
        <div class="header-meta">
            <strong>–ü–µ—Ä–∏–æ–¥:</strong> –ü–æ—Å–ª–µ–¥–Ω–∏–µ {{ period }} –¥–Ω–µ–π |
            <strong>–ö–æ–º–∞–Ω–¥–∞:</strong> {{ team_size }} –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ |
            <strong>–û–±–Ω–æ–≤–ª–µ–Ω–æ:</strong> {{ now.strftime('%d.%m.%Y %H:%M') }}
        </div>
    </div>

    <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">–í—Å–µ–≥–æ –∑–≤–æ–Ω–∫–æ–≤</div>
            <div class="stat-value">{{ total_calls }}</div>
            <div class="stat-change">
                {{ (total_calls / team_size)|round(1) if team_size else 0 }} –Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π QA Score</div>
            <div class="stat-value">{{ avg_quality }}<span style="font-size: 20px">/100</span></div>
            <div class="stat-change {% if avg_quality >= 75 %}positive{% elif avg_quality >= 60 %}{% else %}negative{% endif %}">
                {% if avg_quality >= 80 %}
                    ‚úÖ –û—Ç–ª–∏—á–Ω–æ
                {% elif avg_quality >= 70 %}
                    ‚ö†Ô∏è –•–æ—Ä–æ—à–æ
                {% elif avg_quality >= 60 %}
                    ‚ö†Ô∏è –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ
                {% else %}
                    ‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è —É–ª—É—á—à–µ–Ω–∏–µ
                {% endif %}
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-label">–í—Å–µ–≥–æ –æ–±–µ—â–∞–Ω–∏–π</div>
            <div class="stat-value">{{ total_commitments }}</div>
            <div class="stat-change">
                –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: {{ ((total_commitments - total_overdue) / total_commitments * 100)|round(1) if total_commitments else 100 }}%
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –æ–±–µ—â–∞–Ω–∏–π</div>
            <div class="stat-value" style="color: {% if total_overdue > 0 %}#f56565{% else %}#48bb78{% endif %}">
                {{ total_overdue }}
            </div>
            <div class="stat-change {% if total_overdue == 0 %}positive{% else %}negative{% endif %}">
                {% if total_overdue == 0 %}
                    ‚úÖ –í—Å–µ –≤ —Å—Ä–æ–∫!
                {% else %}
                    ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –ê–ª–µ—Ä—Ç—ã -->
    {% if alerts %}
    <div class="card">
        <div class="card-title">üö® –ê–ª–µ—Ä—Ç—ã ({{ alerts|length }})</div>
        {% for alert in alerts %}
        <div class="alert alert-{{ alert.severity }}">
            <strong>{{ alert.manager_name }}</strong> - {{ alert.message }}
            <small style="float: right; opacity: 0.7">{{ alert.type }}</small>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã -->
    <div class="card">
        <div class="card-title">üë• –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ö–æ–º–∞–Ω–¥—ã</div>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
                    <th>–ó–≤–æ–Ω–∫–æ–≤</th>
                    <th>QA Score</th>
                    <th>–û–±–µ—â–∞–Ω–∏—è</th>
                    <th>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</th>
                    <th>% –í—ã–ø–æ–ª–Ω–µ–Ω–∏—è</th>
                    <th>–ü–æ–¥–æ–∑—Ä.</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                </tr>
            </thead>
            <tbody>
                {% for manager in team_comparison %}
                <tr>
                    <td><strong>{{ loop.index }}</strong></td>
                    <td>
                        <a href="/admin/manager/{{ manager.manager_id }}" style="text-decoration: none; color: #4299e1;">
                            {{ manager.manager_name }}
                        </a>
                    </td>
                    <td>{{ manager.calls_made }}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: 600; {% if manager.avg_quality_score >= 80 %}color: #48bb78{% elif manager.avg_quality_score >= 60 %}color: #ed8936{% else %}color: #f56565{% endif %}">
                                {{ manager.avg_quality_score|round(1) }}
                            </span>
                            <div class="progress-bar" style="width: 100px;">
                                <div class="progress-fill {% if manager.avg_quality_score < 60 %}danger{% elif manager.avg_quality_score < 75 %}warning{% endif %}"
                                     style="width: {{ manager.avg_quality_score }}%"></div>
                            </div>
                        </div>
                    </td>
                    <td>{{ manager.total_commitments }}</td>
                    <td style="{% if manager.overdue_commitments > 0 %}color: #f56565; font-weight: 600{% endif %}">
                        {{ manager.overdue_commitments }}
                    </td>
                    <td>
                        {% if manager.total_commitments > 0 %}
                            {{ ((manager.fulfilled_commitments / manager.total_commitments) * 100)|round(1) }}%
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if manager.suspicious_activity_score > 0.5 %}
                            <span class="badge badge-danger">{{ manager.red_flags_count }} üö©</span>
                        {% elif manager.suspicious_activity_score > 0.3 %}
                            <span class="badge badge-warning">{{ manager.red_flags_count }}</span>
                        {% else %}
                            <span class="badge badge-success">‚úì</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if manager.avg_quality_score >= 80 and manager.commitment_fulfillment_rate >= 90 and manager.suspicious_activity_score < 0.3 %}
                            <span class="badge badge-success">–û—Ç–ª–∏—á–Ω–æ</span>
                        {% elif manager.avg_quality_score >= 60 and manager.commitment_fulfillment_rate >= 70 %}
                            <span class="badge badge-info">–•–æ—Ä–æ—à–æ</span>
                        {% elif manager.avg_quality_score < 60 or manager.overdue_commitments > 3 or manager.suspicious_activity_score > 0.5 %}
                            <span class="badge badge-danger">–ü—Ä–æ–±–ª–µ–º—ã</span>
                        {% else %}
                            <span class="badge badge-warning">–ù–æ—Ä–º–∞</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- –†–µ–π—Ç–∏–Ω–≥–∏ -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="card">
            <div class="card-title">üèÜ –¢–æ–ø –ø–æ –ö–∞—á–µ—Å—Ç–≤—É</div>
            <table>
                <thead>
                    <tr>
                        <th>–ú–µ—Å—Ç–æ</th>
                        <th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
                        <th>–û—Ü–µ–Ω–∫–∞</th>
                    </tr>
                </thead>
                <tbody>
                    {% for manager in leaderboard_quality %}
                    <tr>
                        <td>
                            {% if loop.index == 1 %}ü•á
                            {% elif loop.index == 2 %}ü•à
                            {% elif loop.index == 3 %}ü•â
                            {% else %}{{ loop.index }}{% endif %}
                        </td>
                        <td>{{ manager.manager_name }}</td>
                        <td><strong>{{ manager.avg_quality_score|round(1) }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="card">
            <div class="card-title">üìû –¢–æ–ø –ø–æ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
            <table>
                <thead>
                    <tr>
                        <th>–ú–µ—Å—Ç–æ</th>
                        <th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
                        <th>–ó–≤–æ–Ω–∫–æ–≤</th>
                    </tr>
                </thead>
                <tbody>
                    {% for manager in leaderboard_activity %}
                    <tr>
                        <td>
                            {% if loop.index == 1 %}ü•á
                            {% elif loop.index == 2 %}ü•à
                            {% elif loop.index == 3 %}ü•â
                            {% else %}{{ loop.index }}{% endif %}
                        </td>
                        <td>{{ manager.manager_name }}</td>
                        <td><strong>{{ manager.calls_made }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(() => {
        fetch('/admin/api/refresh-data?period={{ period }}')
            .then(res => res.json())
            .then(data => {
                console.log('Data refreshed:', data.updated_at);
                // –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —á–∞—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            });
    }, 30000);
</script>
{% endblock %}
