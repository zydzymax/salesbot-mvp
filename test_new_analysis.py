"""
–¢–µ—Å—Ç –Ω–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Å YAML –ø—Ä–æ–º–ø—Ç–∞–º–∏ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
"""
import asyncio
import json
import sys

sys.path.insert(0, '/root/salesbot-mvp')

from app.config import get_settings
from app.analysis.pipeline import analyze_dialog

async def main():
    settings = get_settings()

    # –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞ –∏–∑ –±–∞–∑—ã (129 —Å–µ–∫—É–Ω–¥)
    transcript = """–û–ª—å–≥–∞ –ú–∏—Ç—Ä–æ—Ñ–∞–Ω–æ–≤–∞: –ê–ª–ª–æ.
–ö–ª–∏–µ–Ω—Ç: –ê–ª–ª–æ, –∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ.
–û–ª—å–≥–∞ –ú–∏—Ç—Ä–æ—Ñ–∞–Ω–æ–≤–∞: –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ. –ú–µ–Ω—è –∑–æ–≤—É—Ç –û–ª—å–≥–∞, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é —à–≤–µ–π–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –°–∞–≤–∞–Ω–µ–π.
–ö–ª–∏–µ–Ω—Ç: –î–∞.
–û–ª—å–≥–∞ –ú–∏—Ç—Ä–æ—Ñ–∞–Ω–æ–≤–∞: –ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, –≤—ã —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ —Å–µ–π—á–∞—Å –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –¥–ª—è –ø–æ—à–∏–≤–∞ –æ–¥–µ–∂–¥—ã –ø–æ –≤–∞—à–∏–º –ª–µ–∫–∞–ª–∞–º –∏–ª–∏ –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤—Å–µ —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç?
–ö–ª–∏–µ–Ω—Ç: –í—ã –∑–Ω–∞–µ—Ç–µ, –º—ã –≤ –ø—Ä–∏–Ω—Ü–∏–ø–µ –Ω–µ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º, –µ—Å–ª–∏ —á–µ—Å—Ç–Ω–æ. –£ –Ω–∞—Å –µ—Å—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏.
–û–ª—å–≥–∞ –ú–∏—Ç—Ä–æ—Ñ–∞–Ω–æ–≤–∞: –ü–æ–Ω—è—Ç–Ω–æ. –ê —Å–∫–∞–∂–∏—Ç–µ, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –≤–æ–∑–Ω–∏–∫–Ω–µ—Ç –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –æ–±—ä–µ–º–æ–≤ –∏–ª–∏ –∫–∞–∫–∏–µ-—Ç–æ —Ñ–æ—Ä—Å-–º–∞–∂–æ—Ä—ã —É —Ç–µ–∫—É—â–∏—Ö –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤, –∫ –∫–æ–º—É –≤—ã –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å?
–ö–ª–∏–µ–Ω—Ç: –ù—É —É –Ω–∞—Å –µ—Å—Ç—å –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç —Ç–æ–∂–µ, –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ.
–û–ª—å–≥–∞ –ú–∏—Ç—Ä–æ—Ñ–∞–Ω–æ–≤–∞: –ü–æ–Ω—è—Ç–Ω–æ. –ê –º–æ–∂–µ–º –ª–∏ –º—ã —Å –≤–∞–º–∏ –æ—Å—Ç–∞—Ç—å—Å—è –Ω–∞ —Å–≤—è–∑–∏, —á—Ç–æ–±—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤—ã –∑–Ω–∞–ª–∏ –æ –Ω–∞—Å? –ú—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º—Å—è –Ω–∞ —Ç—Ä–∏–∫–æ—Ç–∞–∂–Ω—ã—Ö –∏–∑–¥–µ–ª–∏—è—Ö, —Ä–∞–±–æ—Ç–∞–µ–º —Å –∫—Ä—É–ø–Ω—ã–º–∏ –±—Ä–µ–Ω–¥–∞–º–∏.
–ö–ª–∏–µ–Ω—Ç: –î–∞, –º–æ–∂–µ—Ç–µ –ø—Ä–∏—Å–ª–∞—Ç—å –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –ø–æ—á—Ç—É.
–û–ª—å–≥–∞ –ú–∏—Ç—Ä–æ—Ñ–∞–Ω–æ–≤–∞: –û—Ç–ª–∏—á–Ω–æ! –ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã?
–ö–ª–∏–µ–Ω—Ç: zakaz@fashion-company.ru
–û–ª—å–≥–∞ –ú–∏—Ç—Ä–æ—Ñ–∞–Ω–æ–≤–∞: –°–ø–∞—Å–∏–±–æ! –ê –µ—Å–ª–∏ –º–æ–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å, –∫–∞–∫–∏–µ –æ–±—ä–µ–º—ã –≤—ã –æ–±—ã—á–Ω–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ –≤ –º–µ—Å—è—Ü? –ß—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.
–ö–ª–∏–µ–Ω—Ç: –ù—É –≤ —Å—Ä–µ–¥–Ω–µ–º –æ–∫–æ–ª–æ 5000 –µ–¥–∏–Ω–∏—Ü —Ç—Ä–∏–∫–æ—Ç–∞–∂–∞.
–û–ª—å–≥–∞ –ú–∏—Ç—Ä–æ—Ñ–∞–Ω–æ–≤–∞: –ü–æ–Ω—è—Ç–Ω–æ, —Ö–æ—Ä–æ—à–∏–µ –æ–±—ä–µ–º—ã. –ê —Å –∫–∞–∫–æ–π —Ü–µ–Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç–µ - –º–∞—Å—Å-–º–∞—Ä–∫–µ—Ç –∏–ª–∏ –ø—Ä–µ–º–∏—É–º?
–ö–ª–∏–µ–Ω—Ç: –°—Ä–µ–¥–Ω–∏–π —Å–µ–≥–º–µ–Ω—Ç, —Å–∫–æ—Ä–µ–µ –±–ª–∏–∂–µ –∫ –º–∞—Å—Å-–º–∞—Ä–∫–µ—Ç—É.
–û–ª—å–≥–∞ –ú–∏—Ç—Ä–æ—Ñ–∞–Ω–æ–≤–∞: –Ø—Å–Ω–æ, —Å–ø–∞—Å–∏–±–æ. –ü—Ä–∏—à–ª—é –≤–∞–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å–µ–≥–æ–¥–Ω—è. –ò –µ—Å–ª–∏ –º–æ–∂–Ω–æ, —É—Ç–æ—á–Ω—é - –∫—Ç–æ —É –≤–∞—Å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ –ø–æ –≤—ã–±–æ—Ä—É –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤?
–ö–ª–∏–µ–Ω—Ç: –≠—Ç–æ –Ω–∞—à —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞ –∑–∞–∫—É–ø–æ–∫, –ê–Ω–¥—Ä–µ–π –ü–µ—Ç—Ä–æ–≤–∏—á.
–û–ª—å–≥–∞ –ú–∏—Ç—Ä–æ—Ñ–∞–Ω–æ–≤–∞: –°–ø–∞—Å–∏–±–æ –±–æ–ª—å—à–æ–µ! –û—Ç–ø—Ä–∞–≤–ª—é –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏ —á–µ—Ä–µ–∑ –ø–∞—Ä—É –¥–Ω–µ–π —Å–≤—è–∂—É—Å—å, —á—Ç–æ–±—ã –æ–±—Å—É–¥–∏—Ç—å –¥–µ—Ç–∞–ª–∏. –í–∞–º —É–¥–æ–±–Ω–æ –±—É–¥–µ—Ç –ø–æ–æ–±—â–∞—Ç—å—Å—è?
–ö–ª–∏–µ–Ω—Ç: –î–∞, –º–æ–∂–Ω–æ. –ü–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–µ–¥–µ–ª–∏ —á–µ—Ä–µ–∑ –¥–≤–µ, —É –Ω–∞—Å —Å–µ–π—á–∞—Å –∞–≤—Ä–∞–ª —Å —Ç–µ–∫—É—â–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–µ–π.
–û–ª—å–≥–∞ –ú–∏—Ç—Ä–æ—Ñ–∞–Ω–æ–≤–∞: –û—Ç–ª–∏—á–Ω–æ, –æ—Ç–º–µ—á—É —É —Å–µ–±—è. –°–ø–∞—Å–∏–±–æ –∑–∞ —É–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è!
–ö–ª–∏–µ–Ω—Ç: –°–ø–∞—Å–∏–±–æ, –¥–æ —Å–≤–∏–¥–∞–Ω–∏—è.
–û–ª—å–≥–∞ –ú–∏—Ç—Ä–æ—Ñ–∞–Ω–æ–≤–∞: –í—Å–µ–≥–æ –¥–æ–±—Ä–æ–≥–æ!"""

    print("=" * 80)
    print("–¢–ï–°–¢ –ù–û–í–û–ì–û –ê–ù–ê–õ–ò–ó–ê –° YAML –ü–†–û–ú–ü–¢–ê–ú–ò")
    print("=" * 80)
    print("\n–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–≤–æ–Ω–∫–∞ (129 —Å–µ–∫—É–Ω–¥, —Ä–µ–∞–ª—å–Ω—ã–π –¥–∏–∞–ª–æ–≥):")
    print("-" * 80)
    print(transcript)
    print("-" * 80)

    print("\n" + "=" * 80)
    print("–ó–ê–ü–£–°–ö –ê–ù–ê–õ–ò–ó–ê")
    print("=" * 80)
    print("\n–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:")
    print("  ‚Ä¢ Model: gpt-4o")
    print("  ‚Ä¢ Temperature: 0.15 (—Å—Ç–∞–±–∏–ª—å–Ω—ã–π reasoning)")
    print("  ‚Ä¢ Prompt: call_scoring.v1.yml")
    print("  ‚Ä¢ Response format: json_object (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π JSON)")
    print("  ‚Ä¢ Max retries: 2")
    print("  ‚Ä¢ Consistency checks: enabled")
    print("  ‚Ä¢ Evidence-based: —Ç—Ä–µ–±—É—é—Ç—Å—è —Ü–∏—Ç–∞—Ç—ã –∏–∑ –¥–∏–∞–ª–æ–≥–∞")

    try:
        print("\nüîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –∞–Ω–∞–ª–∏–∑ –≤ ChatGPT...")

        result = await analyze_dialog(
            dialogue_text=transcript,
            api_key=settings.openai_api_key,
            model="gpt-4o",
            temperature=0.15,
            max_retries=2
        )

        print("\n‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!")
        print("\n" + "=" * 80)
        print("–†–ï–ó–£–õ–¨–¢–ê–¢–´ –ê–ù–ê–õ–ò–ó–ê")
        print("=" * 80)

        # === –ö–†–ê–¢–ö–ê–Ø –°–í–û–î–ö–ê ===
        print(f"\nüìä –ö–†–ê–¢–ö–ê–Ø –°–í–û–î–ö–ê")
        print("-" * 80)

        stage = result.get('buying_stage', 'unknown')
        print(f"–°—Ç–∞–¥–∏—è —Å–¥–µ–ª–∫–∏: {stage.upper()}")

        need = result.get('need_summary', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')
        print(f"–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å: {need}")

        # === –ë–Æ–î–ñ–ï–¢ ===
        budget = result.get('budget', {})
        print(f"\nüí∞ –ë–Æ–î–ñ–ï–¢")
        print("-" * 80)
        if budget.get('amount'):
            print(f"–°—É–º–º–∞: {budget.get('amount')} {budget.get('currency')}")
            print(f"–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {budget.get('confidence')}")
            print(f"–ò—Å—Ç–æ—á–Ω–∏–∫: {budget.get('source', '–Ω–µ —É–∫–∞–∑–∞–Ω')}")
        else:
            print(f"–°—Ç–∞—Ç—É—Å: {budget.get('status', '–Ω–µ –æ–∑–≤—É—á–µ–Ω')}")

        # === –õ–ü–† ===
        dm = result.get('decision_maker', {})
        print(f"\nüë§ –õ–ò–¶–û, –ü–†–ò–ù–ò–ú–ê–Æ–©–ï–ï –†–ï–®–ï–ù–ò–ï")
        print("-" * 80)
        print(f"–ò–º—è/–¥–æ–ª–∂–Ω–æ—Å—Ç—å: {dm.get('title', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω')}")
        print(f"–Ø–≤–ª—è–µ—Ç—Å—è –õ–ü–†: {'–î–ê' if dm.get('is_decision_maker') else '–ù–ï–¢'}")
        print(f"–£—Ä–æ–≤–µ–Ω—å –≤–ª–∏—è–Ω–∏—è: {dm.get('influence_level', 'unknown')}")

        # === –¢–ê–ô–ú–õ–ê–ô–ù ===
        timeline = result.get('timeline', {})
        print(f"\n‚è∞ –°–†–û–ö–ò")
        print("-" * 80)
        print(f"–°—Ä–æ—á–Ω–æ—Å—Ç—å: {timeline.get('timing', '–Ω–µ —É–∫–∞–∑–∞–Ω–∞')}")
        if timeline.get('specific_date'):
            print(f"–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –¥–∞—Ç–∞: {timeline.get('specific_date')}")
        if timeline.get('notes'):
            print(f"–ü—Ä–∏–º–µ—á–∞–Ω–∏—è: {timeline.get('notes')}")

        # === –í–û–ó–†–ê–ñ–ï–ù–ò–Ø ===
        objections = result.get('objections', [])
        print(f"\nüí¨ –í–û–ó–†–ê–ñ–ï–ù–ò–Ø –ò –†–ê–ë–û–¢–ê –° –ù–ò–ú–ò ({len(objections)})")
        print("-" * 80)
        if objections:
            for i, obj in enumerate(objections, 1):
                print(f"\n{i}. –¢–∏–ø: {obj.get('type')}")
                print(f"   –¢–µ–∫—Å—Ç: \"{obj.get('text')}\"")
                if obj.get('manager_response'):
                    print(f"   –û—Ç–≤–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞: \"{obj.get('manager_response')}\"")
                status = "‚úÖ –†–ï–®–ï–ù–û" if obj.get('is_resolved') else "‚ùå –ù–ï –†–ï–®–ï–ù–û"
                print(f"   –°—Ç–∞—Ç—É—Å: {status}")
        else:
            print("–í–æ–∑—Ä–∞–∂–µ–Ω–∏–π –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ")

        # === RED FLAGS ===
        risk_flags = result.get('risk_flags', [])
        print(f"\n‚ö†Ô∏è  RED FLAGS - –†–ò–°–ö–ò ({len(risk_flags)})")
        print("-" * 80)
        if risk_flags:
            for i, flag in enumerate(risk_flags, 1):
                print(f"\n{i}. {flag.get('type')} [{flag.get('severity')}]")
                print(f"   {flag.get('description')}")
                if flag.get('evidence'):
                    print(f"   –¶–∏—Ç–∞—Ç–∞: \"{flag.get('evidence')}\"")
        else:
            print("‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∏—Å–∫–æ–≤ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ")

        # === –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò ===
        next_actions = result.get('next_actions', [])
        print(f"\n‚úÖ –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï –î–ï–ô–°–¢–í–ò–Ø ({len(next_actions)})")
        print("-" * 80)
        for i, action in enumerate(next_actions, 1):
            priority_emoji = {"high": "üî¥", "medium": "üü°", "low": "üü¢"}.get(action.get('priority'), "‚ö™")
            print(f"\n{i}. {priority_emoji} [{action.get('priority').upper()}] {action.get('action')}")
            print(f"   –ü—Ä–∏—á–∏–Ω–∞: {action.get('reason')}")

        # === –û–¶–ï–ù–ö–ò ===
        scores = result.get('scores', {})
        print(f"\nüéØ –û–¶–ï–ù–ö–ò –ö–ê–ß–ï–°–¢–í–ê")
        print("-" * 80)
        print(f"–û–±—â–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞: {scores.get('overall_quality', 0)}/100")
        print(f"–†–∞–±–æ—Ç–∞ —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è–º–∏: {scores.get('objection_handling', 0)}/100")
        print(f"–ü–æ–ª–Ω–æ—Ç–∞ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏: {scores.get('qualification_completeness', 0)}/100")

        # === –§–†–ï–ô–ú–í–û–†–ö –°–ò–ì–ù–ê–õ–´ ===
        fw = result.get('framework_signals', {})
        if fw:
            print(f"\nüìã BANT/MEDDIC –°–ò–ì–ù–ê–õ–´")
            print("-" * 80)
            print(f"Budget detected: {fw.get('budget_discussed', False)}")
            print(f"Authority identified: {fw.get('authority_identified', False)}")
            print(f"Need confirmed: {fw.get('need_confirmed', False)}")
            print(f"Timeline discussed: {fw.get('timeline_discussed', False)}")

        # === –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê ===
        evidence = result.get('evidence_spans', [])
        if evidence:
            print(f"\nüìù –ö–õ–Æ–ß–ï–í–´–ï –¶–ò–¢–ê–¢–´ –ò–ó –î–ò–ê–õ–û–ì–ê ({len(evidence)})")
            print("-" * 80)
            for i, ev in enumerate(evidence[:5], 1):  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 5
                print(f"{i}. [{ev.get('category')}] \"{ev.get('text')}\"")

        # === –ú–ï–¢–ê–î–ê–ù–ù–´–ï ===
        meta = result.get('meta', {})
        print(f"\nüìä –ú–ï–¢–ê–î–ê–ù–ù–´–ï –ê–ù–ê–õ–ò–ó–ê")
        print("-" * 80)
        print(f"Model: {meta.get('model')}")
        print(f"Prompt version: {meta.get('prompt_version')}")
        print(f"Language: {meta.get('lang')}")

        # === –ü–û–õ–ù–´–ô JSON ===
        print("\n" + "=" * 80)
        print("–ü–û–õ–ù–´–ô JSON –†–ï–ó–£–õ–¨–¢–ê–¢ (–¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)")
        print("=" * 80)
        print(json.dumps(result, indent=2, ensure_ascii=False))

        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª
        with open('/root/salesbot-mvp/analysis_result.json', 'w', encoding='utf-8') as f:
            json.dump(result, f, indent=2, ensure_ascii=False)

        print("\n" + "=" * 80)
        print(f"‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: /root/salesbot-mvp/analysis_result.json")
        print("=" * 80)

    except Exception as e:
        print(f"\n‚ùå –û–®–ò–ë–ö–ê: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    asyncio.run(main())
